<!-- dashboard.component.html - VERSION CORRIGÉE -->
<div class="dashboard-container">
    
    <!-- Overlay de chargement -->
    <div class="loading-overlay" *ngIf="loading">
        <div class="loading-content">
            <div class="spinner-grow text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <h4 class="mt-3">Chargement du tableau de bord...</h4>
            <p class="text-muted">Récupération des données en temps réel</p>
        </div>
    </div>

    <!-- Contenu principal -->
    <div *ngIf="!loading">
        <!-- Header -->
        <div class="dashboard-header">
            <h1 class="dashboard-title">Tableau de bord opérationnel</h1>
            <div class="header-actions">
                <div class="last-updated">
                    <small class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>
                        Dernière mise à jour: {{ now | date:'HH:mm:ss' }}
                    </small>
                </div>
                <button class="btn btn-action" (click)="refreshData()" [disabled]="loading">
                    <i class="bi" [class.bi-arrow-clockwise]="!loading" [class.bi-hourglass-split]="loading" [class.spin]="loading"></i>
                    {{ loading ? 'Chargement...' : 'Actualiser' }}
                </button>
            </div>
        </div>

        <!-- Notification d'erreur -->
        <div *ngIf="error" class="alert alert-warning alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>Attention :</strong> {{ error }}
            <button type="button" class="btn-close" (click)="error = null" aria-label="Fermer"></button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <!-- Commandes prêtes -->
            <div class="card stat-card ready">
                <div class="card-icon">
                    <i class="bi bi-box-seam-fill"></i>
                </div>
                <div class="card-content">
                    <div class="stat-value">{{ kpis?.orders_ready_to_ship || 0 }}</div>
                    <div class="stat-label">Prêtes à expédier</div>
                    <div class="stat-details">
                        <span class="badge bg-info-subtle text-info">
                            <i class="bi bi-plus-circle me-1"></i>
                            +{{ kpis?.new_orders_today || 0 }} aujourd'hui
                        </span>
                    </div>
                </div>
            </div>

            <!-- En cours de livraison -->
            <div class="card stat-card processing">
                <div class="card-icon">
                    <i class="bi bi-truck"></i>
                </div>
                <div class="card-content">
                    <div class="stat-value">{{ kpis?.deliveries_in_progress || 0 }}</div>
                    <div class="stat-label">En cours</div>
                    <div class="stat-details">
                        <div class="progress-thin">
                            <div class="progress-bar" [style.width.%]="(kpis?.delivery_rate || 0) * 100"></div>
                        </div>
                        <small>Taux: {{ formatPercentage(kpis?.delivery_rate || 0) }}</small>
                    </div>
                </div>
            </div>

            <!-- Livraisons réussies -->
            <div class="card stat-card delivered">
                <div class="card-icon">
                    <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="card-content">
                    <div class="stat-value">{{ kpis?.deliveries_successful || 0 }}</div>
                    <div class="stat-label">Réussies</div>
                    <div class="stat-details">
                        <div class="trend-badge" [class.trend-up]="(kpis?.delivery_rate || 0) > 0.9" 
                                                  [class.trend-down]="(kpis?.delivery_rate || 0) <= 0.9">
                            <i class="bi" [class.bi-arrow-up]="(kpis?.delivery_rate || 0) > 0.9" 
                                       [class.bi-arrow-down]="(kpis?.delivery_rate || 0) <= 0.9"></i>
                            {{ formatPercentage(kpis?.delivery_rate || 0) }}
                        </div>
                        <small>sur {{ kpis?.total_orders || 0 }} commandes</small>
                    </div>
                </div>
            </div>

            <!-- Livraisons échouées -->
            <div class="card stat-card failed">
                <div class="card-icon">
                    <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="card-content">
                    <div class="stat-value">{{ kpis?.deliveries_failed || 0 }}</div>
                    <div class="stat-label">Échecs</div>
                    <div class="stat-details">
                        <div class="revenue-indicator">
                            <i class="bi bi-currency-exchange"></i>
                            {{ formatCurrencyShortCFA(kpis?.total_revenue || 0) }}
                        </div>
                        <small>Revenu total</small>
                    </div>
                </div>
            </div>

            <!-- Utilisateurs actifs -->
            <div class="card stat-card users">
                <div class="card-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="card-content">
                    <div class="stat-value">{{ kpis?.active_users || 0 }}</div>
                    <div class="stat-label">Utilisateurs actifs</div>
                    <div class="stat-details">
                        <div class="success-rate">
                            <i class="bi bi-check2-all me-1"></i>
                            {{ kpis?.delivered_orders || 0 }} livraisons
                        </div>
                        <small>effectuées avec succès</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3><i class="bi bi-graph-up me-2"></i>Analyses et statistiques</h3>
            </div>
            
            <div class="charts-grid">
               <!-- Graphique des performances -->
<div class="card chart-card">
    <div class="card-header">
        <h4><i class="bi bi-speedometer2 me-2"></i>Performances des livraisons</h4>
        <div class="chart-period">
            <span *ngIf="showDemoIndicator" class="badge bg-warning text-dark me-2">
                <i class="bi bi-tools"></i> Mode démo
            </span>
            7 derniers jours
        </div>
    </div>
    <div class="card-body">
        <!-- Message d'information -->
        <div *ngIf="showDemoIndicator" class="alert alert-warning alert-sm mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <div>
                    <small class="fw-bold">Données historiques temporairement indisponibles</small>
                    <div class="text-muted" style="font-size: 0.8rem;">
                        L'API des performances rencontre des difficultés techniques. 
                        Affichage de données de démonstration pour illustrer les fonctionnalités.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas baseChart 
                [data]="lineChartData" 
                [options]="lineChartOptions" 
                [type]="lineChartType">
            </canvas>
        </div>
        
        <div class="chart-legend">
            <span class="legend-item"><div class="legend-color delivery"></div> Livraisons</span>
            <span class="legend-item"><div class="legend-color revenue"></div> Revenu (Mille FCFA)</span>
        </div>
        
        <!-- Message si pas de données (fallback) -->
        <div *ngIf="lineChartData?.labels?.[0] === 'Pas de données' && !showDemoIndicator" 
             class="text-center mt-3">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                Données temporairement indisponibles
            </small>
        </div>
    </div>
</div>

<!-- Graphique camembert -->
<div class="card chart-card">
    <div class="card-header">
        <h4><i class="bi bi-pie-chart-fill me-2"></i>Distribution des statuts</h4>
        <div class="total-orders">
            <span *ngIf="kpis">{{ kpis.total_orders || 0 }} commandes</span>
            <span *ngIf="!kpis">Chargement...</span>
        </div>
    </div>
    <div class="card-body">
        <!-- Message si données de démonstration -->
        <div *ngIf="showDistributionDemo" class="alert alert-info alert-sm mb-3">
            <div class="d-flex align-items-center">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                    <small class="fw-bold">Distribution estimée</small>
                    <div class="text-muted" style="font-size: 0.8rem;">
                        Basée sur les données actuelles de commandes.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas baseChart 
                [data]="doughnutChartData" 
                [options]="doughnutChartOptions" 
                [type]="doughnutChartType">
            </canvas>
        </div>
        
        <!-- Légende des statuts -->
        <div class="status-summary" *ngIf="shouldShowStatusSummary()">
            <div class="status-item" *ngFor="let status of getOrderStatusSummary()">
                <span class="status-dot" [style.backgroundColor]="status.color"></span>
                <span class="status-label">{{ status.label }}:</span>
                <strong>{{ status.value }}</strong>
                <small class="percentage" *ngIf="getStatusPercentage(status.value) !== null">
                    ({{ getStatusPercentage(status.value) }}%)
                </small>
            </div>
        </div>
        
        <!-- Message si pas de données -->
        <div *ngIf="!shouldShowStatusSummary()" class="no-data-message text-center py-4">
            <i class="bi bi-pie-chart text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-2 mb-1">Aucune donnée de distribution disponible</p>
        </div>
    </div>
</div>

        <!-- Top Products Section -->
        <div class="dashboard-section" *ngIf="topProducts.length > 0">
            <div class="section-header">
                <h3><i class="bi bi-trophy-fill me-2"></i>Produits les plus vendus</h3>
                <button class="btn btn-outline" (click)="exportTopProducts()">
                    <i class="bi bi-download me-1"></i>Exporter
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th width="50%">Produit</th>
                            <th width="20%">Quantité</th>
                            <th width="30%" class="text-end">Revenu (FCFA)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let product of topProducts; let i = index">
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="rank-badge">{{ i + 1 }}</span>
                                    <div class="product-info">
                                        <div class="product-name">{{ product.product_name || 'Produit sans nom' }}</div>
                                        <small class="text-muted">
                                            SKU: {{ (product.product_name || 'N/A') | slice:0:8 | uppercase }}
                                        </small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="quantity-badge">{{ product.total_quantity || 0 }}</span>
                                unités
                            </td>
                            <td class="text-end">
                                <div class="revenue-amount">{{ formatCurrencyShortCFA(product.total_revenue || 0) }}</div>
                                <small class="text-success">
                                    <i class="bi bi-arrow-up-right me-1"></i>
                                     {{ calculateRevenuePerUnit(product) * EUR_TO_CFA | number:'1.0-0' }} FCFA/unité                                </small>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr class="table-light">
                            <td colspan="2" class="text-end"><strong>Total :</strong></td>
                            <td class="text-end">
                                <strong>{{ formatCurrencyShortCFA(getTotalRevenue()) }}</strong>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Message si pas de produits -->
        <div *ngIf="topProducts.length === 0" class="dashboard-section">
            <div class="text-center py-4">
                <i class="bi bi-trophy text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">Aucun produit vendu pour le moment</p>
            </div>
        </div>

        <!-- Quick Stats Footer -->
        <div class="dashboard-footer">
            <div class="footer-stats">
                <div class="footer-stat">
                    <i class="bi bi-clock"></i>
                    <span>Mise à jour: {{ now | date:'HH:mm' }}</span>
                </div>
                <div class="footer-stat">
                    <i class="bi bi-database"></i>
                    <span>{{ kpis?.total_orders || 0 }} commandes totales</span>
                </div>
                <div class="footer-stat">
                    <i class="bi bi-cash-coin"></i>
                    <span>CA: {{ formatCurrencyShortCFA(kpis?.total_revenue || 0) }}</span>
                </div>
                <div class="footer-stat">
                    <i class="bi bi-bar-chart"></i>
                    <span>Taux de réussite: {{ formatPercentage(kpis?.delivery_rate || 0) }}</span>
                </div>
            </div>
        </div>
    </div>
</div>
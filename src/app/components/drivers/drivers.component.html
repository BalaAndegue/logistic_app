<div class="drivers-container">
    <!-- En-tête avec actions -->
    <div class="drivers-header">
        <h2>Gestion des Livreurs</h2>
        
        <div class="header-actions" *ngIf="canManageDrivers()">
            <button class="btn btn-primary" (click)="openCreateModal()">
                <i class="bi bi-person-plus"></i>
                Nouveau Livreur
            </button>
        </div>
    </div>

    <!-- Filtres -->
    <div class="filters-section card">
        <div class="filter-grid">
            <div class="filter-group">
                <label class="filter-label">Statut</label>
                <select class="form-select" [(ngModel)]="statusFilter" (change)="applyFilters()">
                    <option *ngFor="let option of statusOptions" [value]="option.value">
                        {{ option.label }}
                    </option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Véhicule</label>
                <select class="form-select" [(ngModel)]="vehicleFilter" (change)="applyFilters()">
                    <option *ngFor="let option of vehicleOptions" [value]="option.value">
                        {{ option.label }}
                    </option>
                </select>
            </div>
            
            <div class="filter-group filter-search">
                <label class="filter-label">Rechercher</label>
                <div class="search-input">
                    <span class="search-icon">
                        <i class="bi bi-search"></i>
                    </span>
                    <input 
                        type="text" 
                        class="search-field" 
                        placeholder="Rechercher par nom, email, téléphone..."
                        [(ngModel)]="searchQuery"
                        (input)="applyFilters()"
                    >
                </div>
            </div>
        </div>
    </div>

    <!-- Cartes des livreurs -->
    <div class="drivers-grid" *ngIf="!loading; else loadingTpl">
        <div class="drivers-cards">
            <div class="driver-card" *ngFor="let driver of paginatedDrivers">
                <div class="card-header">
                    <div class="driver-avatar">
                        <i class="bi bi-person-circle"></i>
                    </div>
                    <div class="driver-basic-info">
                        <h3>{{ driver.full_name }}</h3>
                        <p class="driver-email">{{ driver.email }}</p>
                    </div>
                    <div class="driver-actions" *ngIf="canManageDrivers()">
                        <button class="btn-icon btn-edit" (click)="openEditModal(driver)" title="Modifier">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn-icon btn-delete" (click)="openDeleteModal(driver)" title="Supprimer">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="driver-details">
                        <div class="detail-row">
                            <span class="detail-label">Téléphone:</span>
                            <span class="detail-value">{{ driver.phone }}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Véhicule:</span>
                            <span class="detail-value">
                                <i class="bi" [ngClass]="getVehicleIcon(driver.vehicle_type)"></i>
                                {{ getVehicleLabel(driver.vehicle_type) }}
                                <span *ngIf="driver.license_plate">({{ driver.license_plate }})</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Statut:</span>
                            <span class="status-badge" [ngClass]="getStatusBadgeClass(driver.status)">
                                {{ getStatusLabel(driver.status) }}
                            </span>
                        </div>
                        <div class="detail-row" *ngIf="driver.rating">
                            <span class="detail-label">Note:</span>
                            <span class="detail-value">
                                <span class="rating-stars">
                                    <i class="bi bi-star-fill" *ngFor="let star of [1,2,3,4,5]" 
                                       [class.text-warning]="star <= Math.round(driver.rating)"
                                       [class.text-muted]="star > Math.round(driver.rating)"></i>
                                </span>
                                <span class="rating-value">({{ driver.rating.toFixed(1) }}/5)</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="driver-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ driver.current_delivery_count }}</div>
                            <div class="stat-label">En cours</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ driver.successful_deliveries }}</div>
                            <div class="stat-label">Livrées</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ driver.total_deliveries }}</div>
                            <div class="stat-label">Total</div>
                        </div>
                    </div>
                    
                    <div class="driver-meta">
                        <small>Inscrit le {{ formatDate(driver.created_at) }}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Message vide -->
        <div *ngIf="filteredDrivers.length === 0 && !loading" class="empty-state">
            <i class="bi bi-people"></i>
            <h4>Aucun livreur trouvé</h4>
            <p *ngIf="canManageDrivers()">Cliquez sur "Nouveau Livreur" pour en créer un</p>
            <p *ngIf="!canManageDrivers()">Ajustez vos filtres pour voir les résultats</p>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-section" *ngIf="filteredDrivers.length > 0">
        <div class="pagination-info">
            Affichage de {{ (currentPage - 1) * itemsPerPage + 1 }} à 
            {{ Math.min(currentPage * itemsPerPage, totalItems) }} 
            sur {{ totalItems }} livreurs
        </div>
        
        <div class="pagination-controls">
            <button 
                class="btn-pagination btn-prev" 
                (click)="prevPage()" 
                [disabled]="currentPage === 1"
            >
                <i class="bi bi-chevron-left"></i>
            </button>
            
            <div class="page-numbers">
                <button 
                    *ngFor="let page of pageNumbers" 
                    class="page-number" 
                    [class.active]="page === currentPage"
                    (click)="goToPage(page)"
                >
                    {{ page }}
                </button>
            </div>
            
            <button 
                class="btn-pagination btn-next" 
                (click)="nextPage()" 
                [disabled]="currentPage === totalPages"
            >
                <i class="bi bi-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Modal d'édition/création -->
<div class="modal-overlay" *ngIf="showDriverModal">
    <div class="modal-card">
        <div class="modal-header">
            <h3 class="modal-title">
                {{ editingDriver ? 'Modifier le livreur' : 'Nouveau Livreur' }}
            </h3>
            <button type="button" class="btn-close" (click)="closeDriverModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <form class="driver-form" (ngSubmit)="saveDriver()">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nom complet *</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            [(ngModel)]="driverForm.full_name" 
                            name="full_name"
                            placeholder="Prénom Nom"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input 
                            type="email" 
                            class="form-control" 
                            [(ngModel)]="driverForm.email" 
                            name="email"
                            placeholder="email@example.com"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Téléphone *</label>
                        <input 
                            type="tel" 
                            class="form-control" 
                            [(ngModel)]="driverForm.phone" 
                            name="phone"
                            placeholder="06 12 34 56 78"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type de véhicule *</label>
                        <select 
                            class="form-select" 
                            [(ngModel)]="driverForm.vehicle_type" 
                            name="vehicle_type"
                            required
                        >
                            <option value="BIKE">Vélo</option>
                            <option value="SCOOTER">Scooter</option>
                            <option value="CAR">Voiture</option>
                            <option value="VAN">Camionnette</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Plaque d'immatriculation</label>
                        <input 
                            type="text" 
                            class="form-control" 
                            [(ngModel)]="driverForm.license_plate" 
                            name="license_plate"
                            placeholder="AB-123-CD"
                        >
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Livraisons max/jour</label>
                        <input 
                            type="number" 
                            class="form-control" 
                            [(ngModel)]="driverForm.max_deliveries_per_day" 
                            name="max_deliveries_per_day"
                            min="5"
                            max="50"
                        >
                        <small class="form-text">Nombre maximum de livraisons par jour</small>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button 
                        type="button" 
                        class="btn btn-secondary" 
                        (click)="closeDriverModal()"
                    >
                        Annuler
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        [disabled]="saving"
                    >
                        <span *ngIf="saving" class="btn-spinner"></span>
                        {{ saving ? 'Enregistrement...' : (editingDriver ? 'Mettre à jour' : 'Créer') }}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de suppression -->
<div class="modal-overlay" *ngIf="showDeleteModal && deletingDriver">
    <div class="modal-card modal-sm">
        <div class="modal-header">
            <h3 class="modal-title">Confirmer la suppression</h3>
            <button type="button" class="btn-close" (click)="closeDeleteModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-body">
            <div class="delete-confirmation">
                <div class="warning-icon">
                    <i class="bi bi-exclamation-triangle"></i>
                </div>
                <p>Êtes-vous sûr de vouloir supprimer le livreur <strong>{{ deletingDriver.full_name }}</strong> ?</p>
                <p class="text-muted">Cette action est irréversible et supprimera toutes les données associées.</p>
            </div>
            
            <div class="modal-actions">
                <button 
                    type="button" 
                    class="btn btn-secondary" 
                    (click)="closeDeleteModal()"
                >
                    Annuler
                </button>
                <button 
                    type="button" 
                    class="btn btn-danger"
                    (click)="deleteDriver()"
                    [disabled]="deleting"
                >
                    <span *ngIf="deleting" class="btn-spinner"></span>
                    {{ deleting ? 'Suppression...' : 'Supprimer' }}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Template de chargement -->
<ng-template #loadingTpl>
    <div class="loading-state">
        <div class="spinner"></div>
        <p>Chargement des livreurs...</p>
    </div>
</ng-template>